package wtf.monsoon.client.modules.exploit.disabler

import me.bush.eventbuskotlin.EventListener
import me.bush.eventbuskotlin.listener
import net.minecraft.network.Packet
import net.minecraft.network.play.client.C0FPacketConfirmTransaction
import wtf.monsoon.backend.module.MulticlassModule
import wtf.monsoon.backend.module.mode.ModuleMode
import wtf.monsoon.client.event.EventPacket
import wtf.monsoon.client.event.EventPreMotion
import wtf.monsoon.client.modules.exploit.Disabler
import wtf.monsoon.client.util.math.randomNumber
import wtf.monsoon.client.util.misc.Stopwatch
import java.util.concurrent.LinkedBlockingQueue

class VerusCombatDisabler(name: String, parent: MulticlassModule) : ModuleMode<Disabler>(name, parent) {

    private val packets = LinkedBlockingQueue<Packet<*>>();
    private val timer: Stopwatch = Stopwatch()

    @EventListener
    val eventPacket = fun(e: EventPacket) {
        if (e.packet is C0FPacketConfirmTransaction) {
            val packet = e.packet as C0FPacketConfirmTransaction
            if (packet.uid.toInt() != -1) {
                e.cancel()
                this.packets.add(e.packet)
            }
        }
    }

    @EventListener
    val preMotion = fun(_: EventPreMotion) {
        if (this.timer.hasTimeElapsed(500)) {
            if (packets.size <= 50) {
                if (!packets.isEmpty()) {
                    packets.poll()
                }
            } else {
                for (i in 0..9) {
                    packets.poll()
                }
            }
            this.timer.reset()
        }
    }
}